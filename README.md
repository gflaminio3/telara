# Laravel Telegram Storage (Telara)

A custom Laravel package that provides a storage disk for uploading files to Telegram and retrieving them seamlessly. It integrates effortlessly with Laravel's Filesystem to let you store files through Telegram's API just like you would use S3, local, or any other disk.

<p align="center">
  <img src="https://raw.githubusercontent.com/gflaminio3/telara/master/docs/banner.png" height="300" alt="Laravel Telegram Storage">
  <br>
  <a href="https://packagist.org/packages/gflaminio3/telara"><img alt="Total Downloads" src="https://img.shields.io/packagist/dt/gflaminio3/telara"></a>
  <a href="https://packagist.org/packages/gflaminio3/telara"><img alt="Latest Version" src="https://img.shields.io/packagist/v/gflaminio3/telara"></a>
  <a href="https://packagist.org/packages/gflaminio3/telara"><img alt="License" src="https://img.shields.io/packagist/l/gflaminio3/telara"></a>
</p>

---

## Table of Contents

- [Laravel Telegram Storage (Telara)](#laravel-telegram-storage-telara)
  - [Table of Contents](#table-of-contents)
  - [Requirements](#requirements)
  - [Installation](#installation)
  - [Configuration](#configuration)
    - [Interactive Setup](#interactive-setup)
    - [Manual Setup](#manual-setup)
  - [Usage](#usage)
    - [Basic Operations](#basic-operations)
    - [File Tracking](#file-tracking)
    - [Logging](#logging)
  - [Advanced Usage](#advanced-usage)
    - [Database Tracking](#database-tracking)
    - [JSON Tracking](#json-tracking)
    - [Working with Channels](#working-with-channels)
  - [Testing](#testing)
  - [Limitations](#limitations)
  - [Troubleshooting](#troubleshooting)
  - [Contributing](#contributing)
  - [License](#license)

---

## Requirements

- **PHP 8.3+**
- **Laravel 11+** (or later versions)
- A **Telegram bot token** generated by [BotFather](https://t.me/botfather)

## Installation

Install the package via Composer:

```bash
composer require gflaminio3/telara
```

Publish the configuration file (optional):

```bash
php artisan vendor:publish --tag=telara-config
```

Run migrations for database tracking:

```bash
php artisan migrate
```

## Configuration

### Interactive Setup

The easiest way to configure Telara is using the interactive setup command:

```bash
php artisan telara:configure
```

This command will:
1. Verify your Telegram bot token
2. Fetch available chats (private, groups, channels)
3. Let you select the chat to use
4. Automatically update your `.env` file

### Manual Setup

1. **Add Disk in `config/filesystems.php`:**

```php
'disks' => [
    // ...
    'telegram' => [
        'driver' => 'telara',
        'bot_token' => env('TELEGRAM_BOT_TOKEN'),
        'chat_id' => env('TELEGRAM_CHAT_ID'),
    ],
],
```

2. **Set Environment Variables:**

```env
TELEGRAM_BOT_TOKEN=123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11
TELEGRAM_CHAT_ID=987654321

# Optional configuration
TELARA_TRACK_FILES=true
TELARA_TRACKING_DRIVER=database
TELARA_LOGGING_ENABLED=false
```

3. **Configuration Options (`config/telara.php`):**

- `track_files`: Enable or disable file tracking (default: `true`)
- `tracking_driver`: Storage method for metadata: `none`, `array`, `database`, or `json` (default: `database`)
- `json_tracking_path`: Path for JSON tracking file (default: `storage/app/telara_files.json`)
- `logging.enabled`: Enable package logging (default: `false`)
- `logging.channel`: Laravel logging channel to use (default: `single`)

## Usage

### Basic Operations

```php
use Illuminate\Support\Facades\Storage;

// Upload a file
Storage::disk('telegram')->put('document.pdf', file_get_contents('path/to/document.pdf'));

// Upload with custom caption
Storage::disk('telegram')->put('image.jpg', $imageContents, [
    'caption' => 'My custom caption'
]);

// Check if file exists (requires tracking enabled)
if (Storage::disk('telegram')->exists('document.pdf')) {
    // File exists in tracker
}

// Get file contents by path (requires tracking)
$contents = Storage::disk('telegram')->get('document.pdf');

// Get file contents by Telegram file_id
$contents = Storage::disk('telegram')->get('AgACAgQAAxkBAAIB...');

// List tracked files
$files = Storage::disk('telegram')->files();

// Delete from tracker (doesn't delete from Telegram)
Storage::disk('telegram')->delete('document.pdf');
```

### File Tracking

When `track_files` is enabled, Telara remembers uploaded files and their metadata:

- **`array`**: In-memory tracking (lost after request ends)
- **`database`**: Persistent tracking in `telara_files` table
- **`json`**: Persistent tracking in JSON file
- **`none`**: No tracking (manual file_id management required)

**Database tracking** allows you to:

```php
use Illuminate\Support\Facades\DB;

// Query tracked files
$files = DB::table('telara_files')->get();

// Find by path
$file = DB::table('telara_files')->where('path', 'document.pdf')->first();

// Access metadata
echo $file->file_id;
echo $file->mime_type;
echo $file->size;
```

### Logging

Enable logging to monitor Telara operations:

```env
TELARA_LOGGING_ENABLED=true
TELARA_LOGGING_CHANNEL=single
```

Logs will include:
- Upload attempts and results
- Download operations
- Telegram API responses
- Errors and exceptions

Example log entry:

```
[2024-12-27 12:00:00] local.INFO: Telara: write {"path":"document.pdf","file_id":"AgACAgQAAxk...","success":true}
```

## Advanced Usage

### Database Tracking

For database tracking, ensure migrations are run:

```bash
php artisan migrate
```

This creates the `telara_files` table with columns:
- `id`
- `file_id` (Telegram's unique identifier)
- `path` (your local reference path)
- `file_name`
- `mime_type`
- `size`
- `caption`
- `metadata` (JSON field for additional data)
- `created_at` / `updated_at`

### JSON Tracking

Configure JSON tracking path in `.env`:

```env
TELARA_TRACKING_DRIVER=json
```

Or in `config/telara.php`:

```php
'json_tracking_path' => storage_path('app/telara_files.json'),
```

The JSON file will be created automatically and contains:

```json
{
  "document.pdf": {
    "file_id": "AgACAgQAAxk...",
    "path": "document.pdf",
    "size": 102400,
    "mime_type": "application/pdf",
    "created_at": 1703692800,
    "updated_at": 1703692800
  }
}
```

### Working with Channels

To use a Telegram channel:

1. Create a channel and make it public or get its ID
2. Add your bot as an administrator
3. Use the channel ID (starts with `-100`) as `TELEGRAM_CHAT_ID`

```env
TELEGRAM_CHAT_ID=-1001234567890
```

## Testing

Run the test suite:

```bash
composer test
```

Individual test commands:

```bash
composer lint          # Code style
composer test:types    # Static analysis
composer test:unit     # Unit tests
composer refacto       # Run rector
```

## Limitations

- Telegram has file size limits (20MB for bots, 50MB for premium)
- Files cannot be deleted from Telegram via API
- No directory structure support (flat file storage)
- Download speed depends on Telegram's servers

## Troubleshooting

**"Driver [telara] is not supported"**
- Run `php artisan config:clear`
- Ensure the disk is configured in `config/filesystems.php`

**Upload returns false but file appears in Telegram**
- This is expected behavior; the file is uploaded successfully
- Enable logging to verify operations

**"No chats found" during setup**
- Send a message to your bot first
- Or add the bot to your group/channel
- Run `telara:configure` again

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

## License

This project is open-sourced software licensed under the [MIT license](https://opensource.org/licenses/MIT).

---

**Enjoy building with Telara!** If you find this package useful, please consider starring it on GitHub.